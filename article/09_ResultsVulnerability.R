################################################################################
#
#                         MCC-EUcityTRM
#
#                         Other results
#
################################################################################

# source("00_Packages_Parameters.R")
source("08_ResultsCountry.R")

#---------------------------
# Age-specific predictions
#---------------------------

#----- Predict coefficients for different ages

# Get design matrix for age only (because of factor expansion of region)
mixterms <- delete.response(terms(stage2res))
agemm <- model.matrix(mixterms[grep("age", attr(mixterms, "term.labels"))],
  data.frame(age = agegrid))

# Get meta coefficients and vcov for intercept and age
allmetac <- coef(stage2res)
ageinds <- grep("age|(Intercept)", names(allmetac))
agemetac <- allmetac[ageinds]
agemetav <- vcov(stage2res)[ageinds, ageinds]

# Predict DLNM coefficients and vcov for all ages
agepreds <- apply(agemm, 1, function(x){
  xexp <- t(x) %x% diag(nc)
  coefpred <- xexp %*% agemetac
  vcovpred <- xexp %*% agemetav %*% t(xexp)
  list(fit = coefpred, vcov = vcovpred)
})

#----- Compute ERF

# Multiply to coefficients to obtain rough predicted curve
firstpred <- ov_basis %*% sapply(agepreds, "[[", "fit")

# For each find MMP
agemmp <- ovper[inrange][apply(firstpred[inrange,], 2, which.min)]

# Obtain list of ERF
agecp <- Map(crosspred, basis = list(ov_basis), 
  coef = lapply(agepreds, "[[", "fit"), vcov = lapply(agepreds, "[[", "vcov"),
  model.link = "log", cen = agemmp, at = list(ovper))

#----- Uncertainty of MMP

# Simulate mmps for each age
mmpsimu <- sapply(agepreds, function(x){ 
  csim <- mvrnorm(nsim, x$fit, x$vcov)
  firstpred <- ov_basis %*% t(csim)
  ovper[inrange][apply(firstpred[inrange,], 2, which.min)]
})

# Confidence intervals
mmpci <- apply(mmpsimu, 2, quantile, probs = c(.025, .975))

#---------------------------
# Prediction contribution of each component
#---------------------------

# Initialize data.frame to store results
compres <- metadesc[match(metaprednames, tolower(metadesc$metavar)), 
  c("metavar", "label")]
compres$category <- factor(rep(names(metapreds), lengths(metapreds)),
  levels = unique(names(metapreds)))

#----- Backtransform coefficients to have effect of each metavariable

# Get eigenvectors
# loads <- pcares$rotation[,seq_len(npc)]
loads <- plsres$projection[,1:npc]
colnames(loads) <- sprintf("pls%i", 1:npc)

# Backtransform coefficients
st2coefs <- coef(stage2res, format = "matrix")
inds <- grep("pls", rownames(st2coefs))
plscoefs <- st2coefs[inds,]
backcoefs <- loads %*% plscoefs

# Vcov matrix
inds <- grep("pls", rownames(vcov(stage2res)))
mixvcov <- vcov(stage2res)[inds, inds]
reploads <- loads %x% diag(nc)
backvcov <- reploads %*% mixvcov %*% t(reploads)

#----- Create curves for increase in one SD for each variable

# Crosspred with backtransformed coefficients
backcp <- lapply(seq_along(metaprednames), function(i){
  inds <- (1:nc) + (i - 1) * nc
  crosspred(ov_basis, coef = backcoefs[i,], vcov = backvcov[inds,inds],
    model.link = "log", cen = median(ovper), at = ovper)
})

# Get Heat and cold effect in results data.frame
compres$rrcold <- sapply(backcp, "[[", "allRRfit")[predper == resultper[1],]
compres$rrcold_low <- sapply(backcp, "[[", "allRRlow")[
  predper == resultper[1],]
compres$rrcold_hi <- sapply(backcp, "[[", "allRRhigh")[
  predper == resultper[1],]
compres$rrheat <- sapply(backcp, "[[", "allRRfit")[predper == resultper[2],]
compres$rrheat_low <- sapply(backcp, "[[", "allRRlow")[
  predper == resultper[2],]
compres$rrheat_hi <- sapply(backcp, "[[", "allRRhigh")[
  predper == resultper[2],]

#----- Significance test of effect

# Apply Wald test on coefficients
waldres <- t(sapply(seq_along(metaprednames), function(i){
  inds <- (1:nc) + (i - 1) * nc
  waldstat <- backcoefs[i,,drop = F] %*% solve(backvcov[inds,inds]) %*%
    backcoefs[i,]
  pval <- 1 - pchisq(waldstat, nc)
  return(list(waldstat = waldstat, pvalue = pval))
}))
rownames(waldres) <- metaprednames

# Add bonferroni corrected p-value to data.frame
compres$pval <- unlist(waldres[,2]) * length(metaprednames)

# #----- ERF at extreme values of metapredictors
# 
# # Compute high and low values (of scaled meta-variables)
# extmeta <- apply(scale(metavar), 2, 
#   function(x) quantile(x , c(.01, .99)), simplify = F)
# 
# # Create model matrix
# extmm <- cbind(as.matrix(bdiag(extmeta)), 
#   matrix(agemm[agegrid == 65,], nrow = nm * 2, ncol = 3, byrow = T))
# 
# # Coefficient matrix
# st2coef <- coef(stage2res, format = "matrix")
# ageinds <- grep("(Intercept)|(age)", rownames(st2coef))
# extmetacoefs <- rbind(backcoefs, st2coef[ageinds,])
# extcoefs <- extmm %*% extmetacoefs
# 
# # Obtain predictions of vcov
# expandexts <- extmm %x% diag(nc)
# inds <- c(outer(1:nc, (ageinds - 1) * nc, "+"))
# extmetavcov <- bdiag(backvcov, vcov(stage2res)[inds, inds])
# extvcov <- expandexts %*% as.matrix(extmetavcov) %*% t(expandexts)
# 
# # Predictions of curves for each
# extcp <- lapply(seq_len(nm * 2), function(i){
#   inds <- (1:nc) + (i - 1) * nc
#   firstpred <- ov_basis %*% extcoefs[i,]
#   mmt <- ovper[inrange][which.min(firstpred[inrange])]
#   crosspred(ov_basis, coef = extcoefs[i,], vcov = extvcov[inds,inds],
#     model.link = "log", cen = mmt, at = ovper)
# })
# 
# # Extract heat and cold RRs
# rrcolds <- matrix(sapply(extcp, "[[", "allRRfit")[predper == resultper[1],],
#   ncol = 2, byrow = T, 
#   dimnames = list(NULL, sprintf("pred%s_rrcold", c("low", "hi"))))
# rrcoldlows <- matrix(sapply(extcp, "[[", "allRRlow")[predper == resultper[1],],
#   ncol = 2, byrow = T, 
#   dimnames = list(NULL, sprintf("pred%s_rrcold_low", c("low", "hi"))))
# rrcoldhis <- matrix(sapply(extcp, "[[", "allRRhigh")[predper == resultper[1],],
#   ncol = 2, byrow = T, 
#   dimnames = list(NULL, sprintf("pred%s_rrcold_hi", c("low", "hi"))))
# rrheats <- matrix(sapply(extcp, "[[", "allRRfit")[predper == resultper[2],],
#   ncol = 2, byrow = T, 
#   dimnames = list(NULL, sprintf("pred%s_rrheat", c("low", "hi"))))
# rrheatlows <- matrix(sapply(extcp, "[[", "allRRlow")[predper == resultper[2],],
#   ncol = 2, byrow = T, 
#   dimnames = list(NULL, sprintf("pred%s_rrheat_low", c("low", "hi"))))
# rrheathis <- matrix(sapply(extcp, "[[", "allRRhigh")[predper == resultper[2],],
#   ncol = 2, byrow = T, 
#   dimnames = list(NULL, sprintf("pred%s_rrheat_hi", c("low", "hi"))))
# 
# # Put them and their differences in the result df
# compres <- cbind(compres, rrcolds, rrcoldlows, rrcoldhis, 
#   rrheats, rrheatlows, rrheathis)
# compres$diff_rrcold <- apply(rrcolds, 1, diff)
# compres$diff_rrheat <- apply(rrheats, 1, diff)

