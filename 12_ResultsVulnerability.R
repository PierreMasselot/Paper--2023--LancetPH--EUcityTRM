################################################################################
#
#                         MCC-EUcityTRM
#
#                         Other results
#
################################################################################

if (length(ls()) == 0) source("11_ResultsCountry.R")

#---------------------------
# Age-specific predictions
#---------------------------

#----- Predict coefficients for different ages

# Get design matrix for age only (because of factor expansion of region)
mixterms <- delete.response(terms(stage2res))
agemm <- model.matrix(mixterms[grep("age", attr(mixterms, "term.labels"))],
  data.frame(age = agegrid))

# Get meta coefficients and vcov for intercept and age
allmetac <- coef(stage2res)
ageinds <- grep("age|(Intercept)", names(allmetac))
agemetac <- allmetac[ageinds]
agemetav <- vcov(stage2res)[ageinds, ageinds]

# Predict DLNM coefficients and vcov for all ages
agepreds <- apply(agemm, 1, function(x){
  xexp <- t(x) %x% diag(nc)
  coefpred <- xexp %*% agemetac
  vcovpred <- xexp %*% agemetav %*% t(xexp)
  list(fit = coefpred, vcov = vcovpred)
})

#----- Compute ERF

# Multiply to coefficients to obtain rough predicted curve
firstpred <- ov_basis %*% sapply(agepreds, "[[", "fit")

# For each find MMP
agemmp <- ovper[inrange][apply(firstpred[inrange,], 2, which.min)]

# Obtain list of ERF
agecp <- Map(crosspred, basis = list(ov_basis), 
  coef = lapply(agepreds, "[[", "fit"), vcov = lapply(agepreds, "[[", "vcov"),
  model.link = "log", cen = agemmp, at = list(ovper))

#----- Uncertainty of MMP

# Simulate mmps for each age
mmpsimu <- sapply(agepreds, function(x){ 
  csim <- mvrnorm(nsim, x$fit, x$vcov)
  firstpred <- ov_basis %*% t(csim)
  ovper[inrange][apply(firstpred[inrange,], 2, which.min)]
})

# Confidence intervals
alphalist <- c(.05, .2, .5)
mmpci <- t(apply(mmpsimu, 2, quantile, 
  probs = c(alphalist / 2, 1 - alphalist / 2)))
colnames(mmpci) <- c(t(outer(c("low", "high"), alphalist * 100, 
  paste, sep = "_")))

#---------------------------
# Prediction contribution of each component
#---------------------------

#----- Predict coefficients

# Get design matrix for age only (because of factor expansion of region)
extpls <- apply(pcvar, 2, 
  function(x) quantile(x , c(.01, .99)), simplify = F)

# Create prediction matrix
plsmm <- cbind(1, bdiag(extpls), 
  ns(mean(stage2df$age), knots = ageknots, 
    Boundary.knots = c(0, 100))[rep(1, npc * 2),])

# Get meta coefficients and vcov for intercept and PLS extremes
allmetac <- coef(stage2res)
plsinds <- grep("pls|(Intercept)|age", names(allmetac))
plsmetac <- allmetac[plsinds]
plsmetav <- vcov(stage2res)[plsinds,plsinds]

# Predict DLNM coefficients and vcov for PLS extremes
plspreds <- apply(plsmm, 1, function(x){
  xexp <- t(x) %x% diag(nc)
  coefpred <- xexp %*% plsmetac
  vcovpred <- xexp %*% plsmetav %*% t(xexp)
  list(fit = coefpred, vcov = vcovpred)
})

#----- Compute ERF

# Multiply to coefficients to obtain rough predicted curve
firstpred <- ov_basis %*% sapply(plspreds, "[[", "fit")

# For each find MMP
plsmmp <- ovper[inrange][apply(firstpred[inrange,], 2, which.min)]

# Obtain list of ERF
plscp <- Map(crosspred, basis = list(ov_basis), 
  coef = lapply(plspreds, "[[", "fit"), vcov = lapply(plspreds, "[[", "vcov"),
  model.link = "log", cen = plsmmp, at = list(ovper))

#---------------------------
# Region-specific predictions
#---------------------------

# Create prediction data.frame
plsdats <- matrix(0, ncol = npc, dimnames = list(NULL, sprintf("pls%i", 1:npc)))
regdf <- data.frame(region = unique(metadata$region), 
  age = mean(stage2df$age), plsdats)

# Predict spline coefficients
regcoefs <- predict(stage2res, regdf, vcov = T)

# Construct ERF curves
regERF <- lapply(regcoefs, function(x){
  firstpred <- ov_basis %*% x$fit
  mmt <- ovper[inrange][which.min(firstpred[inrange])]
  crosspred(ov_basis, coef = x$fit, vcov = x$vcov, cen = mmt, at = ovper,
    model.link = "log")
})
names(regERF) <- regdf$region